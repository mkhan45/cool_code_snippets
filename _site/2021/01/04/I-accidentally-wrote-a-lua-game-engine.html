<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>I Accidentally Wrote A Lua Game Engine | Mikail Khan</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="I Accidentally Wrote A Lua Game Engine" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Lately I’ve been working on SIMple Physics, a set of educational physics simulators meant to help teach and learn physics intuitively without expensive lab equipment or in person classes. Each simulator allows users to import and export scenes and potentially add some more advanced functionality through Lua." />
<meta property="og:description" content="Lately I’ve been working on SIMple Physics, a set of educational physics simulators meant to help teach and learn physics intuitively without expensive lab equipment or in person classes. Each simulator allows users to import and export scenes and potentially add some more advanced functionality through Lua." />
<link rel="canonical" href="http://localhost:4000/2021/01/04/I-accidentally-wrote-a-lua-game-engine.html" />
<meta property="og:url" content="http://localhost:4000/2021/01/04/I-accidentally-wrote-a-lua-game-engine.html" />
<meta property="og:site_name" content="Mikail Khan" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-01-04T00:00:00-05:00" />
<script type="application/ld+json">
{"description":"Lately I’ve been working on SIMple Physics, a set of educational physics simulators meant to help teach and learn physics intuitively without expensive lab equipment or in person classes. Each simulator allows users to import and export scenes and potentially add some more advanced functionality through Lua.","url":"http://localhost:4000/2021/01/04/I-accidentally-wrote-a-lua-game-engine.html","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2021/01/04/I-accidentally-wrote-a-lua-game-engine.html"},"headline":"I Accidentally Wrote A Lua Game Engine","dateModified":"2021-01-04T00:00:00-05:00","datePublished":"2021-01-04T00:00:00-05:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Mikail Khan" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Mikail Khan</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">I Accidentally Wrote A Lua Game Engine</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2021-01-04T00:00:00-05:00" itemprop="datePublished">Jan 4, 2021
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Lately I’ve been working on SIMple Physics, a set of educational physics simulators meant to help teach and learn physics intuitively without expensive lab equipment or in person classes. Each simulator allows users to import and export scenes and potentially add some more advanced functionality through Lua.</p>

<p>Until recently, the Lua scripting was fairly limited. It could be used to add/remove objects and change variables such as but crucially it could not affect objects once they were created.gravity, and there was also an update() function which ran every frame.</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- this example instantiates a multicolored grid of circles</span>
<span class="k">for</span> <span class="n">row</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">HEIGHT</span> <span class="k">do</span>
    <span class="k">for</span> <span class="n">col</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">WIDTH</span> <span class="k">do</span>
        <span class="n">color</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span> <span class="o">*</span> <span class="n">col</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">WIDTH</span> <span class="o">*</span> <span class="n">HEIGHT</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">col</span> <span class="o">/</span> <span class="n">WIDTH</span> <span class="o">*</span> <span class="mi">255</span><span class="p">,</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">row</span> <span class="o">/</span> <span class="n">HEIGHT</span> <span class="o">*</span> <span class="mi">255</span>
        <span class="p">}</span>
        <span class="n">add_shape</span><span class="p">{</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="s2">"circle"</span><span class="p">,</span> 
            <span class="n">x</span> <span class="o">=</span> <span class="n">col</span> <span class="o">*</span> <span class="n">OFFSET</span> <span class="o">+</span> <span class="n">START_X_OFFSET</span><span class="p">,</span> 
            <span class="n">y</span> <span class="o">=</span> <span class="n">row</span> <span class="o">*</span> <span class="n">OFFSET</span><span class="p">,</span> 
            <span class="n">r</span> <span class="o">=</span> <span class="n">RAD</span><span class="p">,</span> 
            <span class="n">mass</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> 
            <span class="n">color</span> <span class="o">=</span> <span class="n">color</span>
        <span class="p">}</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Crucially, there was no way to affect individual objects directly once they had been instantiated. By now, you can probably see where this is going.</p>

<p>I’ve been in contact with my physics professor about this project, and he told me that he would like for students to be able to code the equations we learn in class. For example, basic position integration through Euler’s method or the collision equations. With that, I decided to implement a way for the Lua interface to be able to update individual objects.</p>

<p>What I arrived at is object specific update functions. By specifying a function to be called on an object every frame, users can now modify the features of an object including position, velocity, color, etc. Here’s the MVP for an integration lab which lets students write their own integration method:</p>

<div class="language-lua highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">-- the student should edit this function</span>
<span class="kd">local</span> <span class="k">function</span> <span class="nf">integrate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">v_x</span><span class="p">,</span> <span class="n">v_y</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">new_x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">v_x</span> <span class="o">*</span> <span class="n">dt</span><span class="p">,</span>
        <span class="n">new_y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">v_y</span> <span class="o">*</span> <span class="n">dt</span><span class="p">,</span>
    <span class="p">}</span>
<span class="k">end</span>

<span class="n">X_VEL</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">Y_VEL</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

<span class="c1">-- this function is called on the circle every frame</span>
<span class="k">function</span> <span class="nf">update_fn</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">old_x</span><span class="p">,</span> <span class="n">old_y</span> <span class="o">=</span> <span class="n">obj</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">obj</span><span class="p">.</span><span class="n">y</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">integrate</span><span class="p">(</span><span class="n">old_x</span><span class="p">,</span> <span class="n">old_y</span><span class="p">,</span> <span class="n">X_VEL</span><span class="p">,</span> <span class="n">Y_VEL</span><span class="p">,</span> <span class="n">DT</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
    <span class="n">obj</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">obj</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">new_x</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">new_y</span>
    <span class="k">return</span> <span class="n">obj</span>
<span class="k">end</span>

<span class="n">add_shape</span> <span class="p">{</span>
    <span class="n">shape</span><span class="o">=</span><span class="s2">"circle"</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="n">SCREEN_X</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="n">SCREEN_Y</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">r</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">mass</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">update_function</span><span class="o">=</span><span class="s2">"update_fn"</span>
<span class="p">}</span>

<span class="n">GRAVITY</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div></div>

<p>The idea is that students would write their own <code class="language-plaintext highlighter-rouge">integrate()</code> function. Ideally, there should be another circle which uses the simulator’s physics engine, and by comparing the behavior of the two shapes it will be possible to see the error in Euler integration.</p>

<p>As I wrote the examples, I realized that the object specific update functions are pretty similar to the way Unity’s ECS works. The update functions are essentially a script component. While it’s only possible to add one update function to each object, that’s a pretty easy limitation to get around.</p>

<p>Upon this realization, I decided to write Flappy Bird. Here’s where I admit that the title is a bit clickbaity: there’s still no way to handle user input from the Lua scripts, so the program still can’t really be called a game engine. Users can drag around objects with their mouse, so it would be possible to set up physical buttons in the scene, and there are also global <code class="language-plaintext highlighter-rouge">MOUSE_X</code> and <code class="language-plaintext highlighter-rouge">MOUSE_Y</code> Lua variables, but the Lua can’t see keyboard or mouse clicks. Because of this, I wrote a super simple AI to play Flappy Bird.</p>

<p>My Lua code is a bit amateurish and too long for a code snippet, so I’d encourage you to <a href="https://github.com/mkhan45/SIMple-Mechanics/blob/master/lua/flappy_bird.lua">check it out on GitHub</a> if you want to read it.</p>

<p>Building Flappy Bird on top of a physics engine like this is pretty interesting. I didn’t bother to write an end game condition, but if the bird crashes into one of the pipes they both go flying off. Instead of manually updating the x-position of the pipes, I just initialized their velocity to be negative. I assume this is similar to how it would work in Unity or Godot. However, while it’s definitely possible to write games using the engine, it’s not terribly ergonomic. I’m okay with that though.</p>

<p>Something else I was surprised at was the speed of interfacing with Lua from Rust. Every frame, the program is pulling numerous fields of the Lua objects into the physics engine and passing them back to Lua. In the Flappy Bird example, the physics engine is nearly inactive, so I’d expected the Lua system to be more intensive than the physics engine, but it uses about a tenth of the performance if I’m reading my profiler correctly. I’m tempted to rewrite the Universal Gravitation portion of SIMple Physics into a Lua script.</p>

  </div><a class="u-url" href="/2021/01/04/I-accidentally-wrote-a-lua-game-engine.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Mikail Khan</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Mikail Khan</li><li><a class="u-email" href="mailto:mikail.khan45@gmail.com">mikail.khan45@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/mkhan45"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">mkhan45</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>¯\_(ツ)_/¯</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>

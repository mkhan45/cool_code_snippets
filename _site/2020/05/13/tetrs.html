<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Tetrs | Mikail Khan</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Tetrs" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I wrote tetrs (https://github.com/mkhan45/tetrs) over the summer after playing Tetris with some friends on https://jstris.jezevec10.com/. One of my goals when writing it was for it to be written mostly using functional programming. I did complete the actual Tetris part back then, but the UI was pretty bad so I never really used it. I finally got around to finishing it a few weeks ago because of coronabreak." />
<meta property="og:description" content="I wrote tetrs (https://github.com/mkhan45/tetrs) over the summer after playing Tetris with some friends on https://jstris.jezevec10.com/. One of my goals when writing it was for it to be written mostly using functional programming. I did complete the actual Tetris part back then, but the UI was pretty bad so I never really used it. I finally got around to finishing it a few weeks ago because of coronabreak." />
<link rel="canonical" href="http://localhost:4000/2020/05/13/tetrs.html" />
<meta property="og:url" content="http://localhost:4000/2020/05/13/tetrs.html" />
<meta property="og:site_name" content="Mikail Khan" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-05-13T00:00:00-04:00" />
<script type="application/ld+json">
{"description":"I wrote tetrs (https://github.com/mkhan45/tetrs) over the summer after playing Tetris with some friends on https://jstris.jezevec10.com/. One of my goals when writing it was for it to be written mostly using functional programming. I did complete the actual Tetris part back then, but the UI was pretty bad so I never really used it. I finally got around to finishing it a few weeks ago because of coronabreak.","url":"http://localhost:4000/2020/05/13/tetrs.html","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2020/05/13/tetrs.html"},"headline":"Tetrs","dateModified":"2020-05-13T00:00:00-04:00","datePublished":"2020-05-13T00:00:00-04:00","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Mikail Khan" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Mikail Khan</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Tetrs</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2020-05-13T00:00:00-04:00" itemprop="datePublished">May 13, 2020
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>I wrote tetrs (<a href="https://github.com/mkhan45/tetrs">https://github.com/mkhan45/tetrs</a>) over the summer after playing Tetris with some friends on <a href="https://jstris.jezevec10.com/">https://jstris.jezevec10.com/</a>. One of my goals when writing it was for it to be written mostly using functional programming. I did complete the actual Tetris part back then, but the UI was pretty bad so I never really used it. I finally got around to finishing it a few weeks ago because of coronabreak.</p>

<p>As usual, I wrote it in Rust using <code class="language-plaintext highlighter-rouge">ggez</code> as a game engine.</p>

<p><img src="https://raw.githubusercontent.com/mkhan45/tetrs/master/tetrs.png" alt="" /></p>

<hr />

<p> </p>

<p>The main difficulties in writing Tetris come a few main areas:</p>
<ul>
  <li>Block collision</li>
  <li>Tetromino rotation</li>
  <li>Projection for the predicted tetromino placement at the bottom</li>
</ul>

<p>A few months ago I read a post on r/programminghorror or somewhere similar about tetris collision detection function that was hundreds of lines long. As it turns out, Tetris collision detection is really simple if you separate tetrominoes and squares. For that reason, the logic for the board is separated into 3 structs:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Square</code> - A single square, logically just a position tuple but it also has <code class="language-plaintext highlighter-rouge">Rect</code> and <code class="language-plaintext highlighter-rouge">Color</code> fields for drawing.</li>
  <li><code class="language-plaintext highlighter-rouge">Block</code> - A tetromino, but I didn’t know that they were called tetrominoes at the time. This is composed of an array of 4 <code class="language-plaintext highlighter-rouge">Square</code>s, a <code class="language-plaintext highlighter-rouge">BlockType</code> enum, and an <code class="language-plaintext highlighter-rouge">Orientation</code> enum.</li>
  <li><code class="language-plaintext highlighter-rouge">GameState</code> - well a <code class="language-plaintext highlighter-rouge">GameState</code> has the state of the whole game; the relevant fields are <code class="language-plaintext highlighter-rouge">squares</code>, an expandible array of squares, and <code class="language-plaintext highlighter-rouge">current_block</code>, which is a <code class="language-plaintext highlighter-rouge">Block</code>. I thought about having an array of <code class="language-plaintext highlighter-rouge">Option&lt;Square&gt;</code>s for <code class="language-plaintext highlighter-rouge">squares</code>, but a preallocated <code class="language-plaintext highlighter-rouge">Vec&lt;Square&gt;</code> is easier.`</li>
</ul>

<p>With these structs, collision is easily detected by checking if any of the <code class="language-plaintext highlighter-rouge">squares</code> in <code class="language-plaintext highlighter-rouge">GameState</code> have the same position tuple as any of the squares in <code class="language-plaintext highlighter-rouge">current_block</code>. Functional programming ideas help here. <code class="language-plaintext highlighter-rouge">Block</code> has a <code class="language-plaintext highlighter-rouge">translate</code> method. With normal OOP, you’d probably make the signature <code class="language-plaintext highlighter-rouge">fn translate(&amp;mut self, x, y)</code>, but to preserve immutability, I used <code class="language-plaintext highlighter-rouge">fn translate(&amp;self, x, y) -&gt; Block</code>.</p>

<p>This is helpful later on in this method in <code class="language-plaintext highlighter-rouge">GameState</code>:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">fn</span> <span class="nf">try_translate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="nb">i8</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">i8</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">let</span> <span class="n">translated</span> <span class="o">=</span> <span class="k">self</span><span class="py">.current_block</span><span class="nf">.translate</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
   <span class="k">if</span> <span class="n">translated</span><span class="nf">.is_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="py">.squares</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">self</span><span class="py">.current_block</span> <span class="o">=</span> <span class="n">translated</span><span class="p">;</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>I don’t actually use <code class="language-plaintext highlighter-rouge">try_translate</code> on <code class="language-plaintext highlighter-rouge">current_block</code> because a lot more stuff has to happen if <code class="language-plaintext highlighter-rouge">translated</code> is not valid. Instead I did this:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// create a temporary block that is the current_block translated down by one</span>
<span class="k">let</span> <span class="n">translated</span> <span class="o">=</span> <span class="k">self</span><span class="py">.current_block</span><span class="nf">.translate</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">if</span> <span class="n">translated</span><span class="nf">.is_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="py">.squares</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">self</span><span class="py">.current_block</span> <span class="o">=</span> <span class="n">translated</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
   <span class="c">// handle everything that has to do with the current_block colliding </span>
   <span class="o">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<p> </p>

<p>Tetromino rotation was a lot less elegant. As far as I know, it <strong>must</strong> be hardcoded. The bulk of the logic is in <code class="language-plaintext highlighter-rouge">Block::new()</code>, which just specifies an array of squares for every combination of <code class="language-plaintext highlighter-rouge">BlockType</code> and <code class="language-plaintext highlighter-rouge">Orientation</code>. I managed to make it look okay though. Here’s a snippet:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nn">BlockType</span><span class="p">::</span><span class="n">T</span><span class="p">,</span> <span class="nn">Orientation</span><span class="p">::</span><span class="n">Up</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
      <span class="nf">block_from_squares</span><span class="p">(</span><span class="n">blocktype</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> 
         <span class="p">[</span>
                    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> 
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
         <span class="p">]</span>
      <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Of course, autoformatting is turned off for that function.</p>

<p>Rotation is also hardcoded because blocks have to be translated a bit on rotation to remain consistent. There’s some standard way to rotate blocks that I followed.</p>

<hr />
<p> </p>

<p>Making the projection at the bottom was surprisingly difficult. It would be easy to just test every downward translation of the current block, but that would be pretty inefficient. Instead, I tried to find the max drop distance for each square in the block. At first I filtered it to only include the squares at the bottom of the tetromino, but there’s only 4 anyway so that actually makes it slower.</p>

<p>This function finds the max distance that a tetromino can be translated down before hitting something:</p>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">fn</span> <span class="nf">max_drop</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">board</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="n">Square</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="nb">i8</span> <span class="p">{</span>
    <span class="k">self</span><span class="py">.squares</span><span class="nf">.iter</span><span class="p">()</span><span class="nf">.fold</span><span class="p">(</span><span class="n">Y_SQUARES</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="p">|</span><span class="n">max_dist</span><span class="p">,</span> <span class="n">square</span><span class="p">|</span> <span class="p">{</span>
        <span class="k">let</span> <span class="n">square_max</span> <span class="o">=</span> <span class="n">square</span><span class="nf">.max_y_translate</span><span class="p">(</span><span class="n">board</span><span class="p">);</span>
        <span class="k">if</span> <span class="n">square_max</span> <span class="o">&lt;</span> <span class="n">max_dist</span> <span class="p">{</span>
            <span class="n">square_max</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">max_dist</span>
        <span class="p">}</span>
    <span class="p">})</span> <span class="o">-</span> <span class="mi">1</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Y_SQUARES + 5</code> is the max distance a square could be dropped from the time it was spawned.</p>

<p><code class="language-plaintext highlighter-rouge">square.max_y_translate</code> is shown here:</p>
<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">fn</span> <span class="nf">max_y_translate</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">board</span><span class="p">:</span> <span class="o">&amp;</span><span class="p">[</span><span class="n">Square</span><span class="p">])</span> <span class="k">-&gt;</span> <span class="nb">i8</span> <span class="p">{</span>
    <span class="c">// starts by filtering the board to only squares on the same x axis, and then</span>
    <span class="c">// looks down</span>
    <span class="k">let</span> <span class="n">max_square</span> <span class="o">=</span> <span class="n">board</span>
        <span class="nf">.iter</span><span class="p">()</span>
        <span class="nf">.filter</span><span class="p">(|</span><span class="n">square</span><span class="p">|</span> <span class="n">square</span><span class="py">.pos</span><span class="err">.</span><span class="mi">0</span> <span class="o">==</span> <span class="k">self</span><span class="py">.pos</span><span class="err">.</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">square</span><span class="py">.pos</span><span class="err">.</span><span class="mi">1</span> <span class="o">&gt;=</span> <span class="k">self</span><span class="py">.pos</span><span class="err">.</span><span class="mi">1</span><span class="p">)</span>
        <span class="nf">.fold</span><span class="p">(</span><span class="nn">Square</span><span class="p">::</span><span class="nf">bottom</span><span class="p">(</span><span class="k">self</span><span class="py">.pos</span><span class="err">.</span><span class="mi">0</span><span class="p">),</span> <span class="p">|</span><span class="n">max_square</span><span class="p">,</span> <span class="n">current_square</span><span class="p">|</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">current_square</span><span class="py">.pos</span><span class="err">.</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">max_square</span><span class="py">.pos</span><span class="err">.</span><span class="mi">1</span> <span class="p">{</span>
                <span class="o">*</span><span class="n">current_square</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">max_square</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="n">max_square</span><span class="py">.pos</span><span class="err">.</span><span class="mi">1</span> <span class="o">-</span> <span class="k">self</span><span class="py">.pos</span><span class="err">.</span><span class="mi">1</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<p> </p>

<p>Overall, I’m pretty happy with how it turned out. I was able to go back to it after six or so months and add a main menu and fix some bugs without too much difficulty, and I don’t think there’s too much inefficiency anywhere.</p>

  </div><a class="u-url" href="/2020/05/13/tetrs.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Mikail Khan</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Mikail Khan</li><li><a class="u-email" href="mailto:mikail.khan45@gmail.com">mikail.khan45@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/mkhan45"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">mkhan45</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>¯\_(ツ)_/¯</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
